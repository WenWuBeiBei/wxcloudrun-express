# 升级指南

适用于文武贝贝工具集后端框架的版本升级、验证与回滚。

## 升级前检查
- 阅读 [CHANGELOG](CHANGELOG.md) 确认是否有破坏性变更
- 备份：数据库（`mysqldump`）、环境变量（`.env` 或控制台导出）
- 检查 Node.js 版本满足要求（>= 12）

## 本地升级流程
1. 拉取代码：`git pull origin main`
2. 重新安装依赖（如有变更）：
   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```
3. 执行数据库迁移（如有）：`npm run migrate` 或手动 SQL
4. 本地验证：`npm start` 后访问 `http://localhost:80/api/v1/health`

## 微信云托管升级
1. 在控制台「版本管理」中新建版本，选择最新分支
2. 补全新增环境变量，确认端口 `PORT` 与数据库配置
3. 构建发布，等待部署完成
4. 验证：打开云托管日志，访问 `/api/v1/health` 检查返回 `code:0`

## 版本验证清单
- 健康检查：`/api/v1/health` 正常
- 关键接口：OpenID 获取、工具路由占位无 5xx
- 日志：无持续报错，资源占用正常

## 回滚策略
- **本地**：`git checkout <上一版本>`，恢复数据库备份，再启动验证
- **云托管**：在「版本管理」选择上一个稳定版本，点击「部署」回滚

## 迁移提示（从 Demo 到 0.1.0）
- 路径改为 `/api/v1/*`，请更新小程序请求
- Demo 路由被移除；工具模块需自行在 `routes/tools.js` 实现
- 数据库初始化允许无配置启动，若需持久化请设置 MySQL 环境变量

## 常见问题
- **健康检查失败**：检查端口、环境变量、容器启动日志
- **小程序 404**：确认路径是否带 `/api/v1`，域名是否在白名单
- **数据库连接错误**：检查地址/账号/白名单；必要时先关闭自动迁移

如遇未覆盖的问题，优先查看日志，其次在 Issue 中描述现象与版本号。 
