# 开发规范（后端 + 小程序侧）

适用于文武贝贝工具集在微信云托管上的后端开发。

## 代码风格
- 使用 ES6+；变量/函数小驼峰，类大驼峰，常量全大写下划线
- 2 空格缩进，末尾分号，字符串优先单引号
- 尽量无副作用的模块导出，避免全局变量
- 异步统一 `async/await` + `try/catch`，错误向上抛或走统一错误中间件

## 目录与职责
- `routes/`：HTTP 路由，按模块拆分；入口在 `routes/index.js`
- `middleware/`：通用中间件（参数校验、鉴权等）
- `models/`：Sequelize 模型定义，命名用小写复数表名
- `utils/`：通用工具（统一响应、加密、日志包装等）
- `public/`：静态资源与欢迎页
- `docs/`：文档与规范

## API 设计
- 前缀统一 `/api/v1`，按资源名复数：`/tools`、`/users`
- 响应统一 `code`、`message`、`data`；分页返回 `items`、`total`、`page`、`pageSize`
- 常用状态码：0（成功）、400/401/403/404/500、501（占位未实现）
- 需要鉴权的接口预留 Token 或会话方案，小程序侧建议结合登录态

## 参数与校验
- 所有写接口必须校验：必填字段、类型、长度、范围
- 校验失败返回 400，说明清晰可本地化
- 复用 `middleware/validator.js`，或在路由内构建轻量校验函数

## 数据库规范
- 表名小写复数：`tools`、`tool_categories`
- 字段小写下划线：`created_at`、`updated_at`、`deleted_at`
- 统一时区为 `+08:00`
- 生产环境使用迁移；本地可 `sequelize.sync()` 但勿在生产开启 `alter: true`

## 日志与错误
- 业务异常用 `fail(res, msg, code, status)` 返回；系统异常交给错误中间件
- 记录关键信息：请求路径、用户标识（openid 或 user_id）、错误栈
- 不输出敏感信息到客户端或日志（密码、密钥、token）

## 安全要求
- 仅接受 HTTPS；小程序侧默认强制
- 严禁将密钥、数据库口令写入仓库；使用环境变量
- 所有输入都需校验与转义，防 SQL 注入 / XSS
- 控制跨域：生产仅允许小程序/可信域名

## Git 与分支
- 提交信息遵循 Conventional Commits：`feat: `、`fix: `、`docs: ` 等
- 分支建议：`main` 稳定、`develop` 集成、`feature/<name>` 开发
- 提交前本地自测，必要时补充文档与变更日志

## 小程序侧注意
- 所有请求使用 `wx.request` 或云托管 SDK，域名需在「服务器域名」白名单
- 云托管自动注入 `x-wx-openid`；后端验证缺失时返回 400
- 不在小程序端存储敏感信息；如需缓存 OpenID/Token，请使用微信推荐存储接口

## 测试与发布
- 建议对核心路由编写接口测试，覆盖成功与失败分支
- 发布前检查：环境变量、数据库迁移、健康检查 `/api/v1/health`
- 发现异常优先回滚，再排查修复
   - 为常用查询字段添加索引
   - 避免 N+1 查询问题
   - 使用分页查询大数据集

2. **缓存策略**
   - 对不常变化的数据使用缓存
   - 合理设置缓存过期时间

3. **日志记录**
   - 生产环境关闭详细的 SQL 日志
   - 使用合适的日志级别

## 代码审查清单

提交代码前请检查：

- [ ] 代码符合命名规范
- [ ] 添加了必要的注释
- [ ] 进行了错误处理
- [ ] 完成了参数验证
- [ ] 测试通过
- [ ] 没有遗留的 console.log
- [ ] 没有硬编码的配置信息
- [ ] API 响应格式统一
- [ ] 提交信息符合规范

---

本文档会随项目发展持续更新，请定期查阅最新版本。
